<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Model Zero</title>
    <link rel="icon" href="./img/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="./css/reset.css">
    <link rel="stylesheet" href="./css/common.css">
    <link rel="stylesheet" href="./css/notice.css">
    <script src="./script/jquery-3.6.0.js"></script>
</head>

<body>
    <div class="custom-cursor"></div> <!-- ë§ˆìš°ìŠ¤ë”°ë¼ë‹¤ë‹ˆëŠ” ì› -->
    <a href="https://pf.kakao.com/_mIxiYG/chat" target="_blank" rel="noopener noreferrer"><button id="chatButton"><img src="./img/chatbot.png" alt=""><img src="./img/chattxt.svg" alt=""></button> </a>
    <button id="topButton" style="display: none;"><img src="./img/arrow.svg" alt="">Top</button> <!-- íƒ‘ë²„íŠ¼ -->
    <!--ê³µì§€ì‚¬í•­-->
    <!-- header -->
    <div id="header"></div>
    <section class="notice-container">
        <h2>Notice</h2>
        <h1>ê³µì§€ì‚¬í•­</h1>
        <!-- ê²€ìƒ‰ ë° ì •ë ¬ -->
        <div class="notice-filter">
            <select id="categoryFilter">
                <option value="">ì „ì²´</option>
                <option value="ì œëª©">ì œëª©</option>
                <option value="ë‚´ìš©">ë‚´ìš©</option>
            </select>
            <div class="search">
                <input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ìž…ë ¥...">
                <button id="searchButton"><img src="./img/notice-search.svg" alt=""></button>
            </div>
        </div>

        <!-- ðŸ”¹ ê³µì§€ì‚¬í•­ ëª©ë¡ -->
        <div class="notice-list"></div>

        <!-- íŽ˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="pagination" data-type="notice">
            <button class="prev"><img src="./img/page_prev.svg" alt=""></button>
            <span class="page-numbers"></span>
            <button class="next"><img src="./img/page_next.svg" alt=""></button>
        </div>

    </section>

    <!-- í‘¸í„° -->
    <div id="footer"></div>

</body>
<script>
    let noticeList;
    const $list = $('.notice-list');
    $(document).ready(function () {

        $list.on('click', '.notice-item', function (e) {
            const id = $(this).data('id');
            const selectedPost = noticeList.find(n => n.contentId === id);
            sessionStorage.setItem('selectedPost', JSON.stringify(selectedPost));
        });

        // ê³µì§€ ì‚¬í•­ íŽ˜ì´ì§€ ì´ˆê¸° ì‹¤í–‰
        initNoticePage();
    });

    // í™”ë©´íƒ€ìž…
    function getParam(key) {
      const params = new URLSearchParams(location.search);
      return params.get(key);
    }

    const boardType = getParam("contentType") || "notice";
    console.log("boardType: ", boardType);
    const titleMap = {
      notice: "ê³µì§€ì‚¬í•­",
      store: "ì„¤ì¹˜ ë§¤ìž¥",
      news: "ì–¸ë¡  ë³´ë„",
      machine: "ë¨¸ì‹  ì„¤ëª…ì„œ",
    };

    $("h1").text(titleMap[boardType] + " ëª©ë¡");
    $("h2").text(titleMap[boardType]);

    // ê²€ìƒ‰
    async function handleSearch() {
        const searchText = $("#searchInput").val();
        const category = $("#categoryFilter").val();

        const filtered = filterDataList(noticeList, searchText, category);
        renderNoticeList(filtered);
        await updatePaths();
        await setupPagination(".pagination[data-type='notice']", ".notice-item", 6);
    }

    $("#searchButton").click(handleSearch);

    // ì´ˆê¸° ì‹¤í–‰
    async function initNoticePage() {
        noticeList = await fetchNotices();  // âœ… ë°ì´í„° ë°›ì•„ì˜¤ê¸°
        renderNoticeList(noticeList);       // âœ… ì „ì²´ ë Œë”
        await updatePaths();                      // âœ… ì´ë¯¸ì§€/ë§í¬ ê²½ë¡œ ìˆ˜ì •
        await setupPagination(".pagination[data-type='notice']", ".notice-item", 6); // âœ… íŽ˜ì´ì§•
    }

    // ê³µì§€ì‚¬í•­ ì¡°íšŒ
    async function fetchNotices() {
        try {
            return await $.ajax({
                url: `https://api.narrowroad-model.com/model_home_page?func=get-posts&contentType=${boardType}`,
                method: 'GET',
                dataType: 'json',
            });
        } catch (err) {
            console.error("âŒ ê³µì§€ì‚¬í•­ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", err);
            return [];
        }
    }

    // ê³µì§€ì‚¬í•­ ë Œë”ë§
    function renderNoticeList(notices) {

        $list.empty(); // ê¸°ì¡´ ë”ë¯¸ ì‚­ì œ

        notices.forEach(function (notice) {
            const contentText = $(notice.content).text().trim(); // HTML ì•ˆì˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œ
            const original = notice.images && notice.images.length > 0 ? notice.images[0] : '';
            const thumbnail = original
            ? original.replace("https://www.modelzero.kr.s3.amazonaws.com", "https://www.modelzero.kr")
            : './img/no_img.png';
            const date = new Date(notice.timestamp).toLocaleDateString('ko-KR').slice(2); // ë‚ ì§œ ì˜ˆ: 25. 3. 21
            const maskedUserId = notice.adminId.replace(/(?<=.{3})./g, '*'); // ì•„ì´ë”” ë§ˆìŠ¤í‚¹
            const html = `
                <a href="/noticeDetail.html?contentType=${boardType}&id=${notice.contentId}" class="notice-item" data-category="ê³µì§€" data-id="${notice.contentId}">
                    <img src="${thumbnail}" alt="ì¸ë„¤ì¼" onerror="this.onerror=null; this.src='./img/no_img.png';">
                    <p>No. ${notice.contentId}</p>
                    <p class="notice-title">${notice.title}</p>
                    <p class="notice-txt">${contentText.slice(0, 100)}${contentText.length > 100 ? '...' : ''}</p>
                    <div class="notice-meta">
                        <p class="author">${maskedUserId}</p>
                        <p class="date">${date}</p>
                        <p class="view-count"><img src="./img/notice_view.svg" alt="ì¡°íšŒìˆ˜ì•„ì´ì½˜"><span>${notice.view}</span></p>
                   </div>
                </a>
            `;
            $list.append(html);
        });
    }
</script>
<script src="./script/common.js"></script>
</html>